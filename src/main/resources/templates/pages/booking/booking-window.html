<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>수업 신청하기</title>

    <meta name="_csrf" th:content="${_csrf?.token}" />
    <meta name="_csrf_header" th:content="${_csrf?.headerName}" />

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

    <link rel="stylesheet" th:href="@{/css/global.css}">

    <script src="https://js.tosspayments.com/v2/standard"></script>

    <style>
        :root {
            /* 예약 페이지 전용 변수 */
            --state-error: #D32F2F;
            --state-warning: #FFA000;
            --state-success: #388E3C;
            --primary-sub-light: #E3F2FD;
            --bg-surface: #ffffff;
        }

        /* [레이아웃] 메인 컨테이너 중앙 정렬 및 최대 너비 제한 */
        .container {
            max-width: 1100px;
            width: 100%;
            margin: 0 auto;
            padding: 0 20px;
            box-sizing: border-box;
        }

        /* [그리드] 달력 영역이 너무 퍼지지 않도록 비율 조정 */
        .content-grid {
            display: grid;
            grid-template-columns: minmax(auto, 700px) 320px; /* 왼쪽 최대 700px, 오른쪽 320px 고정 */
            gap: 24px;
            align-items: start;
            margin-top: 20px;
            justify-content: center; /* 그리드 전체 중앙 정렬 */
        }

        .page-title { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; font-size: 24px; font-weight: 700; }
        .back-btn { font-size: 24px; cursor: pointer; }

        .card {
            background-color: var(--bg-surface);
            border: 1px solid #e0e0e0; /* var(--divider) 대체값 */
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        /* 달력 스타일 */
        .calendar-header {
            display: flex; justify-content: center; align-items: center; gap: 16px;
            margin-bottom: 20px; font-weight: 700; font-size: 18px; user-select: none;
        }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; gap: 8px; }
        .calendar-grid.headers { margin-bottom: 8px; }
        .day-name { font-size: 12px; color: #666; font-weight: 500; }

        .date-cell {
            padding: 8px; border-radius: 50%; cursor: pointer;
            transition: background-color 0.2s;
            aspect-ratio: 1 / 1; /* 정사각형 유지 */
            display: flex; align-items: center; justify-content: center;
            font-size: 14px;
            max-width: 50px; /* 셀이 너무 커지는 것 방지 */
            margin: 0 auto;
        }
        .date-cell:hover:not(.empty) { background-color: var(--primary-sub-light); }
        .date-cell.selected { background-color: #007bff; color: white; } /* var(--text-primary) 대체 */
        .date-cell.today { border: 1px solid #007bff; font-weight: 700; }
        .date-cell.empty { cursor: default; }

        /* 시간 선택 칩 */
        .time-chips { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .chip {
            padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px;
            cursor: pointer; background: white; transition: all 0.2s; font-size: 13px;
        }
        .chip:hover { border-color: #007bff; color: #007bff; }
        .chip.selected { border-color: #007bff; background-color: #007bff; color: white; font-weight: 700; }
        .chip.disabled { color: #aaa; border-color: #eee; cursor: not-allowed; background: #f9f9f9; }

        /* 입력창 */
        textarea {
            width: 100%; height: 100px; padding: 12px;
            border: 1px solid #ddd; border-radius: 8px;
            resize: none; font-family: inherit; box-sizing: border-box;
        }
        textarea:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 3px var(--primary-sub-light); }

        /* 우측 요약 카드 (Sticky) */
        .summary-card {
            background-color: white; border: 1px solid #ddd; border-radius: 12px;
            padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            position: sticky; top: 20px; /* 스크롤 따라오기 */
        }
        .teacher-info { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
        .teacher-img { width: 50px; height: 50px; background-color: #ddd; border-radius: 10px; }
        .divider-dotted { border-top: 1px dashed #ddd; margin: 20px 0; }
        .info-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 14px; }

        .price-value { font-size: 24px; font-weight: 700; color: #333; margin-top: 4px; }

        .btn-payment {
            width: 100%; padding: 14px; background-color: #007bff; color: white;
            border: none; border-radius: 8px; font-size: 16px; font-weight: 700;
            cursor: pointer; margin-top: 20px; transition: background-color 0.2s;
        }
        .btn-payment:hover { background-color: #0056b3; }
        .btn-payment:disabled { background-color: #ccc; cursor: not-allowed; }

        .alert-box {
            background-color: #FFF8E1; border-left: 4px solid var(--state-warning);
            padding: 12px; border-radius: 4px; font-size: 13px; color: #333;
        }

        /* 모바일 대응 */
        @media (max-width: 768px) {
            .content-grid { grid-template-columns: 1fr; } /* 모바일에서는 1단으로 */
            .summary-card { position: static; } /* 모바일에서는 고정 해제 */
        }
    </style>
</head>
<body>

<header th:replace="~{fragments/header :: header}"></header>

<main class="container">
    <div class="page-title" style="margin-top: 20px;">
        <span class="back-btn" onclick="history.back()">←</span>
        <span>수업 신청하기</span>
    </div>

    <div class="content-grid">
        <section class="left-panel">
            <div class="card">
                <h3 style="margin-bottom: 20px;">날짜 및 시간 선택</h3>

                <div class="calendar-header">
                    <span style="cursor:pointer; padding: 0 10px;" onclick="changeMonth(-1)">&lt;</span>
                    <span id="currentMonthYear">Loading...</span>
                    <span style="cursor:pointer; padding: 0 10px;" onclick="changeMonth(1)">&gt;</span>
                </div>

                <div class="calendar-grid headers">
                    <div class="day-name">일</div><div class="day-name">월</div><div class="day-name">화</div>
                    <div class="day-name">수</div><div class="day-name">목</div><div class="day-name">금</div><div class="day-name">토</div>
                </div>
                <div class="calendar-grid" id="calendarGrid"></div>

                <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px;">
                    <span style="font-size: 14px; font-weight: 700; display: block; margin-bottom: 8px;" id="selectedDateDisplay">날짜를 선택해주세요</span>
                    <div class="time-chips" id="timeSlotsContainer">
                        <span style="font-size:12px; color:#999;">날짜를 클릭하면 가능한 시간이 표시됩니다.</span>
                    </div>
                </div>

                <input type="hidden" id="hiddenTeacherId" th:value="${teacherId}">
            </div>

            <div style="margin-bottom: 8px; font-weight: 500;">요청 메시지</div>
            <textarea id="requestMessage" placeholder="선생님께 전달할 메시지나 학습 목표를 적어주세요."></textarea>

        </section>

        <aside class="right-panel">
            <div class="summary-card">
                <div class="teacher-info">
                    <div class="teacher-img"></div>
                    <div>
                        <div style="font-weight: 700;" th:text="${teacherName}">선생님 이름</div>
                        <div style="font-size: 14px; color: #666;" th:text="${subject}">과목명</div>
                    </div>
                </div>

                <div class="divider-dotted"></div>

                <div class="info-row">
                    <span class="material-icons-outlined" style="font-size: 16px;">calendar_today</span>
                    <span id="summaryDate">일시 : 선택 대기 중</span>
                </div>
                <div class="info-row">
                    <span class="material-icons-outlined" style="font-size: 16px;">videocam</span>
                    <span>장소 : 온라인(Zoom)</span>
                </div>

                <div class="divider-dotted"></div>

                <div class="price-section">
                    <div style="font-size: 14px; color: #666;">결제 금액</div>
                    <div class="price-value" th:text="${#numbers.formatInteger(price, 0, 'COMMA') + '원'}">0원</div>
                </div>

                <input type="hidden" id="hiddenScheduleId">
                <input type="hidden" id="hiddenStudentId" th:value="${studentId}">
                <input type="hidden" id="hiddenPrice" th:value="${price}">

                <button id="paymentBtn" class="btn-payment" onclick="createPayment()">결제하기</button>

                <div style="display: flex; align-items: center; gap: 8px; margin-top: 16px; font-size: 12px; color: #666;">
                    <input type="checkbox" id="agree">
                    <label for="agree" style="cursor: pointer;">구매 조건 및 환불 규정에 동의합니다.</label>
                </div>

                <div class="alert-box" style="margin-top: 8px;">
                    <span style="font-weight: 700;">⚠ 필독:</span>
                    수업 시작 <span style="color:var(--state-error); font-weight: 700;">3일 전</span>까지 취소 시 <span style="color: var(--state-success); font-weight:700;">100% 환불</span>됩니다.
                </div>
            </div>
        </aside>
    </div>

    <footer th:replace="~{fragments/footer :: footer}"></footer>
</main>

<script type="text/javascript">
    const today = new Date();
    let currentYear = today.getFullYear();
    let currentMonth = today.getMonth() + 1;
    let selectedDay = null; // 초기에는 선택 안 함

    document.addEventListener("DOMContentLoaded", function() {
        renderCalendar(currentYear, currentMonth);
    });

    // 1. 달력 렌더링
    function changeMonth(diff) {
        currentMonth += diff;
        if (currentMonth > 12) { currentMonth = 1; currentYear++; }
        else if (currentMonth < 1) { currentMonth = 12; currentYear--; }
        renderCalendar(currentYear, currentMonth);

        // 달 변경 시 선택 초기화
        selectedDay = null;
        document.getElementById('timeSlotsContainer').innerHTML = '<span style="font-size:12px; color:#999;">날짜를 다시 선택해주세요.</span>';
        document.getElementById('selectedDateDisplay').innerText = "날짜를 선택해주세요";
    }

    function renderCalendar(year, month) {
        const calendarGrid = document.getElementById('calendarGrid');
        const header = document.getElementById('currentMonthYear');
        const monthNames = ["1월", "2월", "3월", "4월", "5월", "6월", "7월", "8월", "9월", "10월", "11월", "12월"];

        header.innerText = `${year}년 ${monthNames[month-1]}`;

        calendarGrid.innerHTML = ''; // 초기화

        const firstDay = new Date(year, month - 1, 1).getDay();
        const lastDate = new Date(year, month, 0).getDate();

        // 빈 칸
        for (let i = 0; i < firstDay; i++) {
            calendarGrid.appendChild(document.createElement('div'));
        }

        // 날짜 생성
        for (let day = 1; day <= lastDate; day++) {
            const cell = document.createElement('div');
            cell.className = 'date-cell';
            cell.innerText = day;

            // 오늘 날짜 표시
            if (day === today.getDate() && month === (today.getMonth()+1) && year === today.getFullYear()) {
                cell.classList.add('today');
            }

            cell.onclick = function() {
                document.querySelectorAll('.date-cell').forEach(c => c.classList.remove('selected'));
                cell.classList.add('selected');
                selectDate(day);
            };
            calendarGrid.appendChild(cell);
        }
    }

    // 2. 날짜 선택 & API 호출
    function selectDate(day) {
        selectedDay = day;
        const monthStr = String(currentMonth).padStart(2, '0');
        const dayStr = String(day).padStart(2, '0');
        const dateString = `${currentYear}-${monthStr}-${dayStr}`;

        document.getElementById('selectedDateDisplay').innerText = `선택한 날짜 : ${currentMonth}월 ${day}일`;

        // 우측 요약 초기화
        document.getElementById('hiddenScheduleId').value = "";
        document.getElementById('summaryDate').innerText = "시간을 선택해주세요";

        fetchAvailableTimes(dateString);
    }

    async function fetchAvailableTimes(dateStr) {
        const teacherId = document.getElementById('hiddenTeacherId').value || 1;
        const container = document.getElementById('timeSlotsContainer');
        container.innerHTML = '<span style="font-size:12px;">시간 조회 중...</span>';

        try {
            // [API 연동 포인트] 실제 백엔드 API 주소로 변경 필요
            const response = await fetch(`/api/schedules/availability?teacherId=${teacherId}&date=${dateStr}`);

            if (!response.ok) throw new Error("스케줄 조회 실패");
            const json = await response.json();

            container.innerHTML = '';
            if (!json.data || json.data.length === 0) {
                container.innerHTML = '<span style="font-size:12px; color:#999;">예약 가능한 시간이 없습니다.</span>';
                return;
            }

            json.data.forEach(slot => {
                const btn = document.createElement('button');
                btn.className = 'chip';
                // 시간만 추출 (예: 14:00)
                const timeLabel = slot.startTime.substring(11, 16);
                btn.innerText = timeLabel;

                if(slot.isBooked) {
                    btn.classList.add('disabled');
                    btn.disabled = true;
                } else {
                    btn.onclick = function() {
                        document.querySelectorAll('.chip').forEach(c => {
                            c.classList.remove('selected');
                            c.style.backgroundColor = 'white';
                            c.style.color = 'black';
                        });
                        btn.classList.add('selected');

                        // [중요] 스케줄 ID 저장
                        document.getElementById('hiddenScheduleId').value = slot.scheduleId;
                        document.getElementById('summaryDate').innerText = `${dateStr} ${timeLabel}`;
                    };
                }
                container.appendChild(btn);
            });

        } catch (error) {
            console.error(error);
            container.innerHTML = '<span style="font-size:12px; color:red;">조회 오류 (콘솔 확인)</span>';
        }
    }

    // 3. 결제 로직
    async function createPayment() {
        const agree = document.getElementById('agree');
        const scheduleId = document.getElementById('hiddenScheduleId').value;
        const payBtn = document.getElementById('paymentBtn');

        if (!agree.checked) {
            alert("구매 조건 및 환불 규정에 동의해주세요.");
            agree.focus();
            return;
        }
        if (!scheduleId) {
            alert("수업 시간을 선택해주세요.");
            return;
        }

        // 중복 클릭 방지
        payBtn.disabled = true;
        payBtn.innerText = "결제 준비 중...";

        try {
            // [보안] CSRF 토큰 가져오기 (Spring Security 사용 시 필수)
            const csrfToken = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

            const headers = { 'Content-Type': 'application/json' };
            if (csrfToken && csrfHeader) {
                headers[csrfHeader] = csrfToken;
            }

            // 가예약 요청
            const reqData = {
                studentId: document.getElementById('hiddenStudentId').value,
                scheduleId: scheduleId,
                requestMessage: document.getElementById('requestMessage').value
            };

            const response = await fetch('/api/bookings', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(reqData)
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.message || "예약 생성 실패");
            }

            const bookingData = await response.json();
            // 서버에서 orderId를 받아온다고 가정
            const orderId = bookingData.orderId;

            // Toss 결제창 호출
            const clientKey = "test_ck_yZqmkKeP8gWj1B0QjXRB8bQRxB9l"; // 본인 키 사용
            const tossPayments = TossPayments(clientKey);

            await tossPayments.requestPayment({
                method: "CARD",
                amount: {
                    currency: "KRW",
                    value: Number(document.getElementById('hiddenPrice').value),
                },
                orderId: orderId,
                orderName: "1:1 코딩 수업",
                customerName: "수강생",

                successUrl: window.location.origin + "/payment/success",
                failUrl: window.location.origin + "/payment/fail",
            });

        } catch (error) {
            console.error(error);
            alert("결제 진행 중 오류가 발생했습니다: " + error.message);
            payBtn.disabled = false;
            payBtn.innerText = "결제하기";
        }
    }
</script>
</body>
</html>